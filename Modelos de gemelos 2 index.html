<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartScan Warehouse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }
        #warehouse-map {
            background-image: linear-gradient(to right, #f0f0f0 1px, transparent 1px),
                              linear-gradient(to bottom, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .product-dot {
            transition: all 0.5s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .notification {
            animation: slideIn 0.5s ease, slideOut 0.5s ease 2.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .hero-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .ai-suggestions {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="hidden md:flex md:flex-shrink-0">
            <div class="flex flex-col w-64 bg-indigo-700 text-white">
                <div class="flex items-center justify-center h-16 px-4 border-b border-indigo-600">
                    <div class="flex items-center">
                        <i data-feather="package" class="w-6 h-6 mr-2"></i>
                        <span class="text-xl font-bold hero-title">SmartScan ‚ú®</span>
                    </div>
                </div>
                <div class="flex flex-col flex-grow px-4 py-4 overflow-y-auto">
                    <nav class="space-y-2">
                        <button onclick="switchTab('scan')" class="flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg bg-indigo-800 text-white">
                            <i data-feather="maximize-2" class="w-5 h-5 mr-3"></i>
                            Escanear Producto
                        </button>
                        <button onclick="switchTab('inventory')" class="flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg hover:bg-indigo-600 text-white">
                            <i data-feather="list" class="w-5 h-5 mr-3"></i>
                            Inventario
                        </button>
                        <button onclick="switchTab('digital-twin')" class="flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg hover:bg-indigo-600 text-white">
                            <i data-feather="map" class="w-5 h-5 mr-3"></i>
                            Gemelo Digital
                        </button>
                        <button onclick="switchTab('dashboard')" class="flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg hover:bg-indigo-600 text-white">
                            <i data-feather="activity" class="w-5 h-5 mr-3"></i>
                            Dashboard
                        </button>
                    </nav>
                    <div class="mt-auto pt-4 border-t border-indigo-600">
                        <div class="flex items-center justify-between px-2 py-2 rounded-lg bg-indigo-800">
                            <div class="flex items-center">
                                <i data-feather="wifi" class="w-4 h-4 mr-2"></i>
                                <span id="connection-status" class="text-xs">Conectado</span>
                            </div>
                            <span id="sync-status" class="text-xs bg-green-500 px-2 py-1 rounded-full">Sincronizado</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile sidebar -->
        <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-lg z-50">
            <div class="flex justify-around">
                <button onclick="switchTab('scan')" class="flex flex-col items-center justify-center p-3 text-indigo-700">
                    <i data-feather="maximize-2" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Escanear</span>
                </button>
                <button onclick="switchTab('inventory')" class="flex flex-col items-center justify-center p-3 text-gray-500">
                    <i data-feather="list" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Inventario</span>
                </button>
                <button onclick="switchTab('digital-twin')" class="flex flex-col items-center justify-center p-3 text-gray-500">
                    <i data-feather="map" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Gemelo</span>
                </button>
                <button onclick="switchTab('dashboard')" class="flex flex-col items-center justify-center p-3 text-gray-500">
                    <i data-feather="activity" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Dashboard</span>
                </button>
            </div>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <!-- Top bar -->
            <div class="flex items-center justify-between h-16 px-4 bg-white border-b border-gray-200">
                <div class="flex items-center">
                    <button class="md:hidden mr-3" onclick="toggleSidebar()">
                        <i data-feather="menu" class="w-6 h-6"></i>
                    </button>
                    <h1 class="text-lg font-semibold hero-title" id="current-tab-title">Escanear Producto</h1>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="hidden md:inline text-sm text-gray-600">Bienvenido, Admin</span>
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center">
                        <i data-feather="user" class="w-4 h-4 text-indigo-700"></i>
                    </div>
                </div>
            </div>

            <!-- Notification area -->
            <div id="notification-area" class="fixed top-4 right-4 z-50 space-y-2"></div>

            <!-- Page content -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6">
                <!-- Scan Tab -->
                <div id="scan" class="tab-content active">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold hero-title mb-4">Escanear Producto</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <div id="qr-reader" class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center mb-4">
                                    <div class="text-center p-4">
                                        <i data-feather="camera" class="w-12 h-12 mx-auto text-gray-400 mb-2"></i>
                                        <p class="text-gray-500">Presiona el bot√≥n para escanear</p>
                                        <button onclick="startScanner()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                                            <i data-feather="maximize-2" class="w-4 h-4 mr-2 inline"></i>
                                            Activar Esc√°ner
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-indigo-50 p-4 rounded-lg">
                                    <p class="text-indigo-800 text-sm"><i data-feather="info" class="w-4 h-4 mr-1 inline"></i> Apunta la c√°mara al c√≥digo QR o de barras del producto.</p>
                                </div>
                            </div>
                            <div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo del producto</label>
                                        <input id="codeInput" placeholder="C√≥digo QR o SKU" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                                        <input id="qtyInput" type="number" value="1" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ubicaci√≥n en almac√©n</label>
                                        <input id="locInput" placeholder="Ej: Estanter√≠a A5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div class="pt-2">
                                        <button onclick="saveProduct()" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center justify-center pulse-animation">
                                            <i data-feather="save" class="w-4 h-4 mr-2"></i>
                                            Registrar Producto
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div id="inventory" class="tab-content">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                            <h2 class="text-2xl font-bold hero-title mb-4 md:mb-0">Inventario Actual</h2>
                            <div class="flex space-x-3">
                                <button onclick="refreshTable()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center">
                                    <i data-feather="refresh-cw" class="w-4 h-4 mr-2"></i>
                                    Actualizar
                                </button>
                                <button onclick="exportToCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center">
                                    <i data-feather="download" class="w-4 h-4 mr-2"></i>
                                    Exportar CSV
                                </button>
                                <button onclick="clearInventory()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center">
                                    <i data-feather="trash-2" class="w-4 h-4 mr-2"></i>
                                    Limpiar Todo
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="inventoryTable" class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicaci√≥n</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Data will be inserted here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Digital Twin Tab -->
                <div id="digital-twin" class="tab-content">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                            <h2 class="text-2xl font-bold hero-title mb-4 md:mb-0">Gemelo Digital del Almac√©n</h2>
                            <div class="flex space-x-3">
                                <button onclick="refreshDigitalTwin()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center">
                                    <i data-feather="refresh-cw" class="w-4 h-4 mr-2"></i>
                                    Actualizar Mapa
                                </button>
                            </div>
                        </div>
                        <div class="relative">
                            <div id="warehouse-map" class="w-full h-96 bg-white border border-gray-200 rounded-lg overflow-hidden relative">
                                <!-- Product dots will be added here by JavaScript -->
                            </div>
                            <div class="flex flex-wrap gap-3 mt-4">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                    <span class="text-sm text-gray-600">Stock Bajo (<5)</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></div>
                                    <span class="text-sm text-gray-600">Stock Medio (5-20)</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                                    <span class="text-sm text-gray-600">Stock Alto (>20)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Productos √önicos</p>
                                    <h3 id="unique-products" class="text-2xl font-bold mt-1">0</h3>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center">
                                    <i data-feather="box" class="w-5 h-5 text-indigo-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Total Unidades</p>
                                    <h3 id="total-units" class="text-2xl font-bold mt-1">0</h3>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                                    <i data-feather="layers" class="w-5 h-5 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Ocupaci√≥n</p>
                                    <h3 id="occupancy" class="text-2xl font-bold mt-1">0%</h3>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                                    <i data-feather="database" class="w-5 h-5 text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">√öltima Actualizaci√≥n</p>
                                    <h3 id="last-update" class="text-2xl font-bold mt-1">---</h3>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                                    <i data-feather="clock" class="w-5 h-5 text-purple-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                            <h2 class="text-2xl font-bold hero-title">Alertas de Inventario</h2>
                            <button onclick="generateAISuggestions()" class="mt-2 md:mt-0 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center">
                                <i data-feather="cpu" class="w-4 h-4 mr-2"></i>
                                Generar Sugerencias IA
                            </button>
                        </div>
                        <div id="alerts-container" class="space-y-3">
                            <!-- Alerts will be added here by JavaScript -->
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-semibold">Productos con Stock Bajo</h2>
                            </div>
                            <div id="low-stock-items" class="space-y-2">
                                <!-- Low stock items will be added here -->
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-semibold">Sugerencias Autom√°ticas</h2>
                            </div>
                            <div id="suggestions" class="ai-suggestions space-y-2">
                                <!-- Suggestions will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BACKEND_URL = "http://localhost:3000";
        let qrScanner = null;
        let inventoryData = [];
        let offlineQueue = [];
        let isOnline = true;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            checkConnection();
            loadFromLocalStorage();
            refreshTable();
            refreshDashboard();

            // Check connection status periodically
            setInterval(checkConnection, 5000);
            
            // Try to sync offline data periodically
            setInterval(syncOfflineData, 10000);
        });

        // Tab switching
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show the selected tab
            document.getElementById(tabId).classList.add('active');
            
            // Update the title
            const titles = {
                'scan': 'Escanear Producto',
                'inventory': 'Inventario',
                'digital-twin': 'Gemelo Digital',
                'dashboard': 'Dashboard'
            };
            document.getElementById('current-tab-title').textContent = titles[tabId];
            
            // Update mobile menu icons
            if (window.innerWidth < 768) {
                document.querySelectorAll('.mobile-menu button').forEach(btn => {
                    btn.classList.remove('text-indigo-700');
                    btn.classList.add('text-gray-500');
                });
                document.querySelector(`button[onclick="switchTab('${tabId}')"]`).classList.remove('text-gray-500');
                document.querySelector(`button[onclick="switchTab('${tabId}')"]`).classList.add('text-indigo-700');
            }
            
            // Special actions for specific tabs
            if (tabId === 'digital-twin') {
                refreshDigitalTwin();
            } else if (tabId === 'dashboard') {
                refreshDashboard();
            }
        }

        // Toggle sidebar for mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.hidden.md\\:flex');
            sidebar.classList.toggle('hidden');
        }

        // QR Scanner
        async function startScanner() {
            const qrRegion = document.getElementById('qr-reader');
            qrRegion.innerHTML = '<div class="w-full h-full flex items-center justify-center"><div class="animate-pulse text-center"><i data-feather="camera" class="w-12 h-12 mx-auto text-indigo-500 mb-2"></i><p class="text-indigo-800">Iniciando c√°mara...</p></div></div>';
            feather.replace();
            
            try {
                qrScanner = new Html5Qrcode("qr-reader");
                await qrScanner.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: 250 },
                    (decodedText) => {
                        document.getElementById("codeInput").value = decodedText;
                        qrScanner.stop().then(() => {
                            qrRegion.innerHTML = '<div class="w-full h-full flex items-center justify-center bg-green-50"><div class="text-center p-4"><i data-feather="check-circle" class="w-12 h-12 mx-auto text-green-500 mb-2"></i><p class="text-green-800 font-medium">C√≥digo detectado:</p><p class="text-sm text-gray-700 break-all">' + decodedText + '</p></div></div>';
                            feather.replace();
                            document.getElementById("qtyInput").focus();
                        });
                    },
                    (errorMessage) => {
                        console.error('QR Scanner error:', errorMessage);
                    }
                );
            } catch (err) {
                qrRegion.innerHTML = '<div class="w-full h-full flex items-center justify-center bg-red-50"><div class="text-center p-4"><i data-feather="alert-circle" class="w-12 h-12 mx-auto text-red-500 mb-2"></i><p class="text-red-800 font-medium">Error al iniciar c√°mara</p><p class="text-sm text-gray-700">' + err.message + '</p></div></div>';
                feather.replace();
            }
        }

        // Save product to backend and localStorage (persistent storage)
        async function saveProduct() {
            const code = document.getElementById("codeInput").value.trim();
            const qty = Number(document.getElementById("qtyInput").value || 1);
            const location = document.getElementById("locInput").value.trim() || "Sin ubicaci√≥n";
            
            if (!code) {
                showNotification('Por favor escanea o ingresa un c√≥digo', 'error');
                return;
            }
            
            const product = { code, qty, location, ts: new Date().toISOString() };
            
            // Always save to localStorage first (persistent storage)
            addToLocalStorage(product);
            showNotification('‚úÖ Producto guardado localmente', 'success');
            
            // Try to save to backend if online
            if (isOnline) {
                try {
                    const res = await fetch(`${BACKEND_URL}/api/scan`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(product)
                    });
                    
                    const data = await res.json();
                    if (data.ok) {
                        showNotification('‚úÖ Producto registrado en servidor', 'success');
                    } else {
                        showNotification('‚ö†Ô∏è Producto guardado localmente (servidor ocupado)', 'warning');
                    }
                } catch (err) {
                    showNotification('‚ö†Ô∏è Producto guardado localmente (sin conexi√≥n)', 'warning');
                }
            } else {
                showNotification('‚ö†Ô∏è Producto guardado localmente (sin conexi√≥n)', 'warning');
            }
            
            // Refresh UI
            refreshTable();
            refreshDashboard();
            refreshDigitalTwin();
            
            // Clear inputs
            document.getElementById("codeInput").value = "";
            document.getElementById("qtyInput").value = "1";
            document.getElementById("locInput").value = "";
        }

        // Refresh inventory table
        async function refreshTable() {
            try {
                // Always get data from localStorage (persistent storage)
                const localData = getLocalStorageData();
                const dataToShow = localData;
                
                // Sort by timestamp (newest first)
                dataToShow.sort((a, b) => new Date(b.ts) - new Date(a.ts));
                
                const tableBody = document.getElementById("inventoryTableBody");
                tableBody.innerHTML = "";
                
                if (dataToShow.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No hay productos registrados</td></tr>';
                    return;
                }
                
                dataToShow.forEach(item => {
                    const tr = document.createElement("tr");
                    tr.className = "hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.code}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.qty}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.location}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.ts)}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (err) {
                console.error('Error refreshing table:', err);
                const tableBody = document.getElementById("inventoryTableBody");
                tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error al cargar el inventario</td></tr>';
            }
        }

        // Export to CSV - Fixed and improved version
        function exportToCSV() {
            try {
                const localData = getLocalStorageData();
                if (localData.length === 0) {
                    showNotification('No hay datos para exportar', 'info');
                    return;
                }
                
                // Create CSV content
                let csvContent = "C√≥digo,Cantidad,Ubicaci√≥n,Fecha/Hora\n";
                localData.forEach(item => {
                    // Escape commas and quotes in fields
                    const escapeField = (field) => {
                        if (typeof field === 'string' && (field.includes(',') || field.includes('"'))) {
                            return `"${field.replace(/"/g, '""')}"`;
                        }
                        return field;
                    };
                    
                    csvContent += `${escapeField(item.code)},${escapeField(item.qty)},${escapeField(item.location)},"${formatDate(item.ts)}"\n`;
                });
                
                // Create blob and download
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `inventario_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('üì§ Datos exportados exitosamente', 'success');
            } catch (err) {
                console.error('Error exporting to CSV:', err);
                showNotification('‚ùå Error al exportar datos', 'error');
            }
        }

        // Clear inventory
        async function clearInventory() {
            if (!confirm('¬øEst√°s seguro de que deseas limpiar todo el inventario? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                clearLocalStorage();
                showNotification('üóëÔ∏è Inventario limpiado exitosamente', 'success');
                refreshTable();
                refreshDashboard();
                refreshDigitalTwin();
            } catch (err) {
                console.error('Error clearing inventory:', err);
                showNotification('‚ùå Error al limpiar inventario', 'error');
            }
        }

        // Refresh digital twin view
        function refreshDigitalTwin() {
            const warehouseMap = document.getElementById('warehouse-map');
            warehouseMap.innerHTML = '';
            
            const localData = getLocalStorageData();
            const dataToShow = localData;
            
            if (dataToShow.length === 0) {
                warehouseMap.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-400">No hay productos para mostrar</div>';
                return;
            }
            
            dataToShow.forEach(item => {
                // Simulate positions in the warehouse
                const locationHash = hashString(item.location || 'default');
                const x = (locationHash % 80) + 5; // 5-85%
                const y = ((locationHash * 2) % 80) + 5; // 5-85%
                
                // Determine color based on quantity
                let color = 'green-500';
                if (item.qty > 20) color = 'red-500';
                else if (item.qty > 5) color = 'yellow-500';
                
                const dot = document.createElement('div');
                dot.className = `product-dot absolute w-6 h-6 rounded-full bg-${color} border-2 border-white cursor-pointer flex items-center justify-center text-white text-xs font-bold`;
                dot.style.left = `${x}%`;
                dot.style.top = `${y}%`;
                dot.title = `${item.code} - ${item.qty} unidades\nUbicaci√≥n: ${item.location}`;
                
                warehouseMap.appendChild(dot);
            });
        }

        // Refresh dashboard
        function refreshDashboard() {
            const localData = getLocalStorageData();
            const dataToShow = localData;
            
            // Update stats
            document.getElementById('unique-products').textContent = new Set(dataToShow.map(item => item.code)).size;
            document.getElementById('total-units').textContent = dataToShow.reduce((sum, item) => sum + item.qty, 0);
            
            // Simple occupancy calculation (for demo purposes)
            const occupancy = Math.min(100, Math.round(dataToShow.length / 50 * 100));
            document.getElementById('occupancy').textContent = `${occupancy}%`;
            
            // Last update time
            if (dataToShow.length > 0) {
                const lastUpdate = new Date(Math.max(...dataToShow.map(item => new Date(item.ts).getTime())));
                document.getElementById('last-update').textContent = formatDate(lastUpdate.toISOString());
            } else {
                document.getElementById('last-update').textContent = '---';
            }
            
            // Generate alerts
            const alertsContainer = document.getElementById('alerts-container');
            alertsContainer.innerHTML = '';
            
            // Check for low stock (qty < 5)
            const lowStockItems = dataToShow.filter(item => item.qty < 5);
            if (lowStockItems.length > 0) {
                const alert = createAlert(`‚ö†Ô∏è Tienes ${lowStockItems.length} producto(s) con stock bajo (<5)`, 'warning');
                alertsContainer.appendChild(alert);
            }
            
            // Check for high stock (qty > 50)
            const highStockItems = dataToShow.filter(item => item.qty > 50);
            if (highStockItems.length > 0) {
                const alert = createAlert(`üì¶ Tienes ${highStockItems.length} producto(s) con exceso de stock (>50)`, 'info');
                alertsContainer.appendChild(alert);
            }
            
            // Check for items without location
            const noLocationItems = dataToShow.filter(item => !item.location || item.location === 'Sin ubicaci√≥n');
            if (noLocationItems.length > 0) {
                const alert = createAlert(`üìç ${noLocationItems.length} producto(s) sin ubicaci√≥n asignada`, 'info');
                alertsContainer.appendChild(alert);
            }
            
            // If no alerts
            if (alertsContainer.children.length === 0) {
                const alert = createAlert('‚úÖ Todo est√° en orden. No hay alertas.', 'success');
                alertsContainer.appendChild(alert);
            }
            
            // Update low stock items list
            const lowStockList = document.getElementById('low-stock-items');
            lowStockList.innerHTML = '';
            
            if (lowStockItems.length > 0) {
                lowStockItems.slice(0, 5).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-red-50 rounded-lg';
                    div.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full bg-red-500 mr-3"></div>
                            <div>
                                <p class="text-sm font-medium">${item.code}</p>
                                <p class="text-xs text-gray-500">${item.location || 'Sin ubicaci√≥n'}</p>
                            </div>
                        </div>
                        <span class="text-red-600 font-bold">${item.qty}</span>
                    `;
                    lowStockList.appendChild(div);
                });
                
                if (lowStockItems.length > 5) {
                    const more = document.createElement('div');
                    more.className = 'text-center text-sm text-gray-500 mt-2';
                    more.textContent = `+${lowStockItems.length - 5} m√°s...`;
                    lowStockList.appendChild(more);
                }
            } else {
                lowStockList.innerHTML = '<p class="text-center text-gray-500 py-4">No hay productos con stock bajo</p>';
            }
            
            // Update suggestions
            const suggestionsList = document.getElementById('suggestions');
            suggestionsList.innerHTML = '';
            
            if (highStockItems.length > 0) {
                const suggestion = document.createElement('div');
                suggestion.className = 'flex items-start p-3 bg-blue-50 rounded-lg';
                suggestion.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-blue-500 mr-3 mt-1"></div>
                    <div>
                        <p class="text-sm font-medium">Considera redistribuir productos con exceso de stock</p>
                        <p class="text-xs text-gray-500">${highStockItems.length} producto(s) con m√°s de 50 unidades</p>
                    </div>
                `;
                suggestionsList.appendChild(suggestion);
            }
            
            if (dataToShow.length > 30) {
                const suggestion = document.createElement('div');
                suggestion.className = 'flex items-start p-3 bg-purple-50 rounded-lg';
                suggestion.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-purple-500 mr-3 mt-1"></div>
                    <div>
                        <p class="text-sm font-medium">Almac√©n con alta ocupaci√≥n</p>
                        <p class="text-xs text-gray-500">${dataToShow.length} productos registrados</p>
                    </div>
                `;
                suggestionsList.appendChild(suggestion);
            }
            
            if (noLocationItems.length > 0) {
                const suggestion = document.createElement('div');
                suggestion.className = 'flex items-start p-3 bg-yellow-50 rounded-lg';
                suggestion.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-yellow-500 mr-3 mt-1"></div>
                    <div>
                        <p class="text-sm font-medium">Asigna ubicaciones a los productos</p>
                        <p class="text-xs text-gray-500">${noLocationItems.length} producto(s) sin ubicaci√≥n</p>
                    </div>
                `;
                suggestionsList.appendChild(suggestion);
            }
            
            if (suggestionsList.children.length === 0) {
                suggestionsList.innerHTML = '<p class="text-center text-gray-500 py-4">No hay sugerencias en este momento</p>';
            }
        }

        // Generate AI suggestions
        function generateAISuggestions() {
            const localData = getLocalStorageData();
            if (localData.length === 0) {
                showNotification('No hay datos para generar sugerencias', 'info');
                return;
            }
            
            showNotification('üß† Generando sugerencias con IA...', 'info');
            
            // Simulate AI analysis (in a real implementation, this would call an AI API)
            setTimeout(() => {
                const suggestionsList = document.getElementById('suggestions');
                suggestionsList.innerHTML = '';
                
                // Analyze inventory patterns
                const totalProducts = localData.length;
                const totalUnits = localData.reduce((sum, item) => sum + item.qty, 0);
                const avgStock = totalUnits / totalProducts || 0;
                const lowStockItems = localData.filter(item => item.qty < 5);
                const highStockItems = localData.filter(item => item.qty > 50);
                const noLocationItems = localData.filter(item => !item.location || item.location === 'Sin ubicaci√≥n');
                
                // Generate AI-like suggestions
                const suggestions = [
                    {
                        icon: 'trending-up',
                        title: 'Optimizaci√≥n de Stock',
                        description: `El promedio de stock es de ${avgStock.toFixed(1)} unidades por producto. Considera ajustar los niveles de reorden.`
                    },
                    {
                        icon: 'bar-chart-2',
                        title: 'An√°lisis de Rotaci√≥n',
                        description: 'Productos con m√°s de 50 unidades pueden estar inmovilizando capital. Eval√∫a su rotaci√≥n.'
                    }
                ];
                
                if (lowStockItems.length > 0) {
                    suggestions.push({
                        icon: 'alert-triangle',
                        title: 'Reposici√≥n Urgente',
                        description: `‚ö†Ô∏è ${lowStockItems.length} productos necesitan reposici√≥n inmediata para evitar rupturas.`
                    });
                }
                
                if (noLocationItems.length > 0) {
                    suggestions.push({
                        icon: 'map-pin',
                        title: 'Organizaci√≥n del Almac√©n',
                        description: `üìç ${noLocationItems.length} productos no tienen ubicaci√≥n asignada. Mejora la eficiencia organiz√°ndolos.`
                    });
                }
                
                if (totalProducts > 100) {
                    suggestions.push({
                        icon: 'layout',
                        title: 'Categorizaci√≥n de Productos',
                        description: 'Con m√°s de 100 productos, considera implementar un sistema de categorizaci√≥n para mejor gesti√≥n.'
                    });
                }
                
                // Add suggestions to UI
                suggestions.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'flex items-start p-3 bg-purple-50 rounded-lg mb-2';
                    div.innerHTML = `
                        <i data-feather="${suggestion.icon}" class="w-4 h-4 mr-3 mt-0.5 text-purple-600"></i>
                        <div>
                            <p class="text-sm font-medium text-purple-800">${suggestion.title}</p>
                            <p class="text-xs text-purple-600">${suggestion.description}</p>
                        </div>
                    `;
                    suggestionsList.appendChild(div);
                });
                
                feather.replace();
                showNotification('‚úÖ Sugerencias generadas con √©xito', 'success');
            }, 1500);
        }

        // Check internet connection
        function checkConnection() {
            const onlineStatus = navigator.onLine;
            if (onlineStatus !== isOnline) {
                isOnline = onlineStatus;
                if (isOnline) {
                    document.getElementById('connection-status').textContent = 'Conectado';
                    document.getElementById('sync-status').textContent = 'Sincronizando...';
                    document.getElementById('sync-status').classList.remove('bg-yellow-500');
                    document.getElementById('sync-status').classList.add('bg-blue-500');
                    showNotification('üîå Conexi√≥n restablecida. Sincronizando datos...', 'success');
                    syncOfflineData();
                } else {
                    document.getElementById('connection-status').textContent = 'Sin conexi√≥n';
                    document.getElementById('sync-status').textContent = 'Pendiente';
                    document.getElementById('sync-status').classList.remove('bg-green-500');
                    document.getElementById('sync-status').classList.add('bg-yellow-500');
                    showNotification('‚ö†Ô∏è Sin conexi√≥n. Los datos se guardar√°n localmente.', 'warning');
                }
            }
        }

        // Sync offline data when connection is restored
        async function syncOfflineData() {
            if (!isOnline) return;
            
            try {
                const localData = getLocalStorageData();
                let successCount = 0;
                
                // Try to sync all local data with backend
                for (const item of localData) {
                    try {
                        const res = await fetch(`${BACKEND_URL}/api/scan`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(item)
                        });
                        
                        const data = await res.json();
                        if (data.ok) {
                            successCount++;
                        }
                    } catch (err) {
                        // Continue with next item if one fails
                        continue;
                    }
                }
                
                if (successCount > 0) {
                    showNotification(`üîÑ ${successCount} producto(s) sincronizados con el servidor`, 'success');
                }
                
                document.getElementById('sync-status').textContent = 'Sincronizado';
                document.getElementById('sync-status').classList.remove('bg-blue-500');
                document.getElementById('sync-status').classList.add('bg-green-500');
            } catch (err) {
                console.error('Error syncing offline data:', err);
            }
        }

        // Local storage functions (persistent storage)
        function addToLocalStorage(product) {
            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            // Check if product already exists, update if so
            const existingIndex = inventory.findIndex(item => item.code === product.code);
            if (existingIndex !== -1) {
                inventory[existingIndex] = { ...inventory[existingIndex], ...product };
            } else {
                inventory.push(product);
            }
            localStorage.setItem('inventory', JSON.stringify(inventory));
        }

        function getLocalStorageData() {
            return JSON.parse(localStorage.getItem('inventory') || '[]');
        }

        function clearLocalStorage() {
            localStorage.removeItem('inventory');
        }

        function loadFromLocalStorage() {
            // Data is automatically loaded from localStorage when needed
            const inventory = getLocalStorageData();
            if (inventory.length > 0) {
                document.getElementById('sync-status').textContent = `${inventory.length} productos`;
                document.getElementById('sync-status').classList.remove('bg-green-500');
                document.getElementById('sync-status').classList.add('bg-blue-500');
            }
        }

        // Helper functions
        function showNotification(message, type) {
            const notificationArea = document.getElementById('notification-area');
            const notification = document.createElement('div');
            notification.className = `notification px-4 py-3 rounded-lg shadow-md max-w-xs flex items-start ${type === 'error' ? 'bg-red-100 text-red-800' : 
                                                                                        type === 'success' ? 'bg-green-100 text-green-800' : 
                                                                                        type === 'warning' ? 'bg-yellow-100 text-yellow-800' : 
                                                                                        'bg-blue-100 text-blue-800'}`;
            notification.innerHTML = `
                <i data-feather="${type === 'error' ? 'alert-triangle' : 
                                 type === 'success' ? 'check-circle' : 
                                 type === 'warning' ? 'alert-circle' : 'info'}" 
                   class="w-5 h-5 mr-2 mt-0.5"></i>
                <span>${message}</span>
            `;
            notificationArea.appendChild(notification);
            feather.replace();
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function createAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `flex items-start p-3 rounded-lg ${type === 'error' ? 'bg-red-50 text-red-800' : 
                                                                   type === 'success' ? 'bg-green-50 text-green-800' : 
                                                                   type === 'warning' ? 'bg-yellow-50 text-yellow-800' : 
                                                                   'bg-blue-50 text-blue-800'}`;
            alert.innerHTML = `
                <i data-feather="${type === 'error' ? 'alert-triangle' : 
                                 type === 'success' ? 'check-circle' : 
                                 type === 'warning' ? 'alert-circle' : 'info'}" 
                   class="w-4 h-4 mr-2 mt-0.5"></i>
                <span class="text-sm">${message}</span>
            `;
            feather.replace();
            return alert;
        }

        function formatDate(timestamp, forFileName = false) {
            const date = new Date(timestamp);
            if (forFileName) {
                return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}-${date.getMinutes().toString().padStart(2, '0')}`;
            }
            return date.toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }
    </script>
    <script>feather.replace();</script>
</body>
</html>